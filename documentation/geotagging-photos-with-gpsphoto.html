<?xml version='1.0' encoding='iso-8859-2'?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
   "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
 <meta http-equiv="content-type" content="text/html; charset=iso-8859-2"/>
 <meta name="DC.creator" content="Tomasz Przechlewski" />
 <meta name='DC.date' content='2010-06-16T07:53:58CEST'/>
 <meta name='DC.rights' content='(c) Tomasz Przechlewski'/>

<!-- default styles: --> 
<link rel="stylesheet" type="text/css" href="/style/tp-base.css" title='ES'/>
<link rel="alternate stylesheet" type="text/css" href="/style/tp-bw.css" title='NS'/>
<link rel="alternate stylesheet" type="text/css" href="/style/tp-big.css" title='BS'/>
<!-- script -->
<script type="text/javascript" src="/script/tp.js"></script>
 

<title>Geotagowanie zdjêæ z gspPhoto</title>
</head>
<body xml:lang="pl">

<h2 class='main'>Geotagowanie zdjêæ z gspPhoto
<a class='flushright' href="./geotagging-photos-with-gpsphoto_en.html">
 <img longdesc="[[uk-f.gif" src="/icons_/uk-f.gif" alt="UK"/></a>
</h2>

<h3>Streszczenie</h3>

<p>
Ten dokument opisuje jak dodaæ tagi EXIF zawieraj±ce
wspó³rzêdne geograficzne do zdjêæ zrobionych 
aparatem cyfrowym wykorzystuj±c ¶lad pobrany z odbiornika GPS
i skrypt Perlowy
<a href='http://www.carto.net/projects/photoTools/gpsPhoto/'>GPSphoto</a>.
</p>

<h3>Sposób postêpowania</h3>

<p>W celu precyzyjnej synchronizacji zegarów obu urz±dzeñ na pocz±tku
wycieczki zrobiæ zdjêcie odbiornika GPS z wy¶wietlonym na ekranie
czasem.
</p>

<p>Zgraæ zdjêcia do jakiego¶ katalogu. Zgraæ ¶lad z GPS, np. pos³uguj±c
siê skryptem wykorzystuj±cym program gpsBabel:
</p>

<pre>
#!/bin/bash
# Get Data from Garmin GPS Receiver ... 
#
TODAY=`date +"%Y%m%d"`
gpsbabel -t -r -w -i garmin -f /dev/ttyS0 -o gpx -F "$TODAY.gpx"
</pre>

<p>Po zapisaniu ¶ladu do pliku GPX ustaliæ ró¿nicê czasu pomiêdzy
zegarami w obu urz±dzeniach. Przyk³adowo w moim Geko 301 wy¶wietlany
jest czas lokalny a zapisywany czas GMT.  Dodatkowo jest pewna ró¿nica
wynikaj±ca z niezbyt precyzyjnego zegara w aparacie i/lub
przybli¿onego zgrania czasu w obu urz±dzeniach. W celu zgrania czasu
nale¿y ustaliæ tak± liczbê sekund (<em>time_offset</em>) aby:
</p>

<p style='text-align: center ; font-style : italic'>
czas_kamery - time_offset = czas_GMT
</p>

<p>Przesuniêcie <em>time_offset</em> wyznaczamy w sekundach, bo w takich
jednostkach nale¿y je podaæ uruchamiaj±c skrypt gpsBabel. Zadanie u³awia
skrypt <a href="/prog/scripts/flickr/scripts/exif_datetime.pl">exif_datetime.pl</a>:
</p>

<pre>
exif_datetime.pl  -f dscf2452.jpg -b 11:56:23
</pre>

<p>Gdzie: <code>dscf2452.jpg</code> to zdjêcie ekranu z wy¶wietlonym
czasem; <code>11:56:23</code> to czas wy¶wietlony na ekranie.  Skrypt
<code>exif_datetime.pl</code> porównuje ten czas z czasem okre¶laj±cym moment, w którym wykonano zdjêcie
zapisanym w odpowiednim polu EXIF. Wypisuje ró¿nicê w sekundach.
</p>

<p>
<strong>Uwaga</strong>: Poniewa¿ na ekranie widzimy czas lokalny
nale¿y jeszcze go uwzglêdniæ ró¿nice miêdzy tym czasem a czasem GMT.
Przyk³adowo, odj±æ 3600 sekund, je¿eli miêdzy obu czasami jest
godzina ró¿nicy.
Skrypt <code>exif_datetime.pl</code> mo¿na wywo³aæ z trzecim
parametrem okre¶laj±cym ró¿nicê (w sekundach) 
pomiêdzy czasem wy¶wietlanym a czasem GMT.
Je¿eli nie podano trzeciego parametru od czasu wy¶wietlanego na ekranie 
GPSa odejmowane jest 3600 sekund.
</p>

<div style='float : right'>
 <a href='http://www.flickr.com/tprzechlewski/2152603178/'>
 <img  width='180px' alt='[Time sync]'
   src='http://static.flickr.com/2281/2152603178_122f07a0c3_m.jpg'/>
 </a>
</div>

<p>Przyk³adowo rysunek obok przedstawia hipotetyczn± sytuacjê, 
w której na ekranie
widzimy, ¿e zdjêcie wykonano 29 grudnia 2007 roku o godzinie 11:56:23. 
Za³ó¿my ponadto, ¿e ten czas 
zosta³ zapisany przez GPSa jako 10:56:23 (zwróæmy wagê na pozycjê: 
<em>UTC offset</em>, która ma warto¶æ +01:00).
Z kolei 
aparat <a href='http://www.flickr.com/photo_exif.gne?id=2152603178'>zarejestrowa³</a>, 
¿e zdjêcie wykonano o godzinie 11:55:39.
Po uruchomieniu skryptu w sposób podany wy¿ej
na ekranie pojawi siê kilka wierszy wydruku, ostatni z nich zawiera 
wynik, np.:
</p>

<pre>
dscf2452.jpg 2007:12:29 11:55:39 -3556
</pre>

<p>Liczba <em>-3556</em> jest szukanym przesuniêciem.</p>

<div class='uwaga'>
<p><strong>Uwaga:</strong>
poniewa¿ uruchamianie <code>exif_datetime</code> 
w ww. sposób dla ka¿dej sesji zdjêciowej
jest pracoch³onne, to skrypt zapisuje obliczone 
przesuniêcia w pliku <code>~/.time_offset</code>.
Wpisanie po prostu:
</p>
<pre>
exif_datetime 
</pre>
<p>
wy¶wietli przesuniêcia czasowe z pliku <code>~/.time_offset</code>. Poniewa¿
czas w aparatach rozsynchronizowuje siê w miarê 
wolno, wystarczy co kilka tygodni aktualizowaæ <code>~/.time_offset</code>.
</p>
<p>
Skrypt <code>exif_datetime</code> jest na tyle cwany,
¿e zapisuje w <code>~/.time_offset</code>
przesuniêcia dla ka¿dego aparatu oddzielnie. Dok³adnie mówi±c dla ka¿dego
<em>typu aparatu</em> oddzielnie (pobiera zawarto¶æ pola <code>Model</code> ze zdjêcia). 
</p>

</div>

<p>Teraz mo¿na uruchomiæ skrypt <code>gpsPhoto.pl</code>:</p>

<pre>
perl gpsPhoto.pl --dir=jpgs --gpsfile=20071229.gpx --timeoffset=-3556 \
  --overwrite-geotagged --kml 20071228.kml
</pre>

<p>Proponujê dla bezpieczeñstwa zawsze 
dodawaæ opcjê <code>--overwrite-geotagged</code>, bo
inaczej raz geo-oznakowane zdjêcia nie s± domy¶lnie brane pod uwagê. Jak siê
na przyk³ad pomylimy i uruchomimy <code>gpsPhoto.pl</code> 
raz jeszcze, to mo¿emy otrzymaæ dziwne wyniki.
Argument <code>--kml 20071229.kml</code> powoduje 
wygenerowanie pliki w formacie KML (GoogleEarth). 
Zamiast wywo³ywaæ <code>gpsPhoto.pl</code> bezpo¶rednio mo¿na uruchomiæ skrypt
basha pn. <code>My-photo-sync</code>:
</p>

<pre>
My-Photo-sync -d katalog -f plik.gpx -t time-offset
</pre>

<p>
<strong>W tym momencie zdjêcia w katalogu s± oznaczone 
wspó³rzêdnymi geograficznymi.</strong>
Oczywi¶cie, tylko te, dla których nast±pi³a synchronizacja czasu
a ¶lad siê nie urwa³, bo przyk³adowo robili¶my zdjêcie w tunelu
¶w. Bernarda.
</p>

<div class='uwaga'>
<p><strong>Uwaga:</strong> mo¿na te¿ napisaæ:</p>
<pre>
My-photo-sync.sh -d katalog-zdjêæ -f plik.gpx -a
</pre>
<p>
Przesuniêcie zostanie pobrane automatycznie 
z pliku <code>~/.time_offset</code>. [Nie trzeba
uruchamiaæ <code>exif_datetime </code>.]
</p>
</div>

<h3>Publikowanie plików KML i/lub GPX</h3>

<p>
Ten punkt jest lu¼no zwi±zany z tematem i dotyczy publikowania plików
KML i/lub GML z zaznaczonymi zdjêciami przy za³o¿eniu, ¿e pliki ze
zdjêciami znajduj± siê na flickr.com. 
Je¿eli nie jeste¶ u¿ytkownikiem flickr.com, to prawdopodobnie mo¿esze pomin±æ ten punkt.
</p>

<p>Plik KML wygenerowany przez <code>gpsPhoto.pl</code> w opisany wy¿ej sposób zawiera
wpisy dotycz±ce ka¿dego zdjêcie w postaci elementów <code>&lt;Placemark></code>
o strukturze podanej na poni¿szym przyk³adzie:
</p>

<pre>
    &lt;Placemark>
      &lt;name>dscf2456.jpg&lt;/name>
      &lt;description>&lt;![CDATA[&lt;a href="/usr/local/share/Images/2007/12/29/dscf2456.jpg">&lt;img 
          src="/usr/local/share/Images/2007/12/29/dscf2456.jpg" 
          width="200" />&lt;/a>&lt;br>&lt;a 
          href="/usr/local/share/Images/2007/12/29/dscf2456.jpg">full size&lt;/a>]]&gt;&lt;/description>
      &lt;Snippet/>
      &lt;LookAt>
        &lt;longitude>18.551144600&lt;/longitude>
        &lt;latitude>54.449744225&lt;/latitude>
        &lt;range>10000&lt;/range>
        &lt;tilt>50&lt;/tilt>
        &lt;heading>0&lt;/heading>
      &lt;/LookAt>
      &lt;styleUrl>#Photo&lt;/styleUrl>
      &lt;Point>
        &lt;altitudeMode>clampToGround&lt;/altitudeMode>
        &lt;coordinates>18.551144600,54.449744225,39&lt;/coordinates>
      &lt;/Point>
    &lt;/Placemark>
</pre>

<p>
Plik taki mo¿na ogl±daæ na swoim komputerze, ale jego opublikowanie
w Internecie wymaga poprawienia zawarto¶ci atrybutów
<code>href</code>. Skrypt <code></code> poprawia plik, tak aby element
<code>a</code> wskazywa³  na stronê g³ówn± ze zdjêciem na flickr.com
a miniatura zdjêcia by³a pobierana tak¿e ze strony flickr.com ale jako
plik w rozmiarze thumbnail, tj. 75x100 pikseli.
</p>

<pre>
kml-adjust-photo-url.sh 20071229.kml
</pre>

<p>Zadanie o tyle nie jest trywialne, ¿e URLe plików na flickr.com maj± dziwn± 
postaæ. W skrócie (<a href='/wblog/gps_babel_etc.html'>tutaj</a> jest wiêcej):
odsy³acze do zdjêæ na flickr.com s± tworzone wed³ug ustalonego schematu.
Strona g³ówna zdjêcia ma adres <code>http://www.flickr.com/photos/&lt;nazwa_u¿ytkownika>/&lt;photo_id>/</code>, gdzie
<code>&lt;photo_id></code> oznacza identyfikator zdjêcia. 
Plik ze zdjêciem ma za¶ nastêpuj±cy URL:
<code>http://static.flickr.com/&lt;server>/&lt;photo_id>_&lt;secret>_&lt;size>.jpg</code>
przy czym warto¶ci <code>&lt;server></code> oraz <code>&lt;secret></code> mo¿na ustaliæ,
np. poprzez wykonanie metody <code>flickr.people.getPublicPhotos</code>.
Warto¶ciami <code>&lt;size></code> s± <code>s</code>, <code>t</code> , <code>m</code>, <code>b</code> 
oraz <code>o</code>.
</p>

<p>Skrypt
<code>flickr_getphotolist.pl</code>
pobiera informacje nt. wszystkich zdjêæ publicznych i zapisuje j± lokalnie na dysku
w pliku <code>~/.flickr/hr.icio.ph</code>.
</p>

<p>Skrypt <code>flickr_photo_urls tytu³-zdjêcia</code> wypisuje
wszystkie URLe do plików dla zdjêcia o podanym tytule. ¯eby dzia³a³,
zdjêcia musz± byæ oczywi¶cie na flickr.com. No i wreszcie skrypt
<code>kml-adjust-urls</code> poprawia linki:
</p>

<pre>
kml-adjust-urls 20071229.kml > 20071229_ok.kml
</pre>

<p>które teraz wygl±daj± jak na poni¿szym przyk³adzie:</p>

<pre>
&lt;Placemark>
 &lt;name>dscf2456.jpg&lt;/name>
 &lt;description>&lt;![CDATA[&lt;a 
   href="http://www.flickr.com/tprzechlewski/2151818571/">&lt;img 
   src="http://static.flickr.com/2261/2151818571_ee436beee6_m.jpg" 
   width="200" />&lt;/a>&lt;br>&lt;a 
   href="http://www.flickr.com/tprzechlewski/2151818571/">full size&lt;/a>
]]&gt;&lt;/description>
      &lt;Snippet>&lt;/Snippet>
&lt;!-- ... itd ... -->
</pre>

<p>Ponadto skrypt generuje listê (do pliku <code>20071229.wpts</code>)
elementów <code>wpt</code> w takim formacie, ¿e na google maps
po klikniêciu w pinezkê, pokazuje siê miniatura 
zdjêcia (Por. <a href='/Geo/trasa.php?trasa=20071229'>przyk³ad</a>).
</p>

<h3>Pobierz</h3>

<p>Omawiane skrypty s± <a href="./scripts">tutaj</a>.</p>


<!-- ;;; -->

<p>
<a href="./opis_new.html"><img
 longdesc="[[back.png" src="/icons_/back.png" alt="Powrót"/>Powrót</a>
</p>

</body>
</html>
<!--
Local variables:
 mode: nxml
 time-stamp-start:"name='DC.date' content='"
 time-stamp-end:"'/>"
 time-stamp-line-limit:0
 LocalWords: Przechlewski geotagowanie GPS tagi geotagi Emacs preprocesora
 LocalWords: GPSLongitudeRef GPSLatitudeRef GPSLatitude GPSLongitude GPSAreaInformation
 ispell-local-dictionary: "polish"
End:
-->
